$(function(){$("#like").click(function(){var id=$("#d_id").val();var params="&d_id="+id;if($("#like_num").hasClass("btnilike")){$.ajax({type:"post",url:"/uajax/addDishFav",data:params,dataType:"json",success:function(msg){if(msg.data.flag=="NoLogin"){logindialog()}else{if(msg.data.flag=="slice"){showerrorinfo("提示",msg.data.favs)}else{if(msg.status=="OK"){var userimage=$("#comment_container").find(".coimg > a > img").attr("src");var username=$("#comment_container").find(".coimg > a > img").attr("alt");var userurl=$("#comment_container").find(".coimg > a").attr("href");$("#like_num").html("已喜欢("+parseInt(msg.data.favs)+")");$("#like_num").removeClass("btnilike").addClass("btndilike");$(".creno").parent().attr("class","izan clearfix mb30");var hasnum=msg.data.favs;if(parseInt(hasnum)&&$(".creno").parent().attr("class")=="izan clearfix mb30"){$(".creno").parent().show();$(".creno").parent().find("h3 a").html("("+(hasnum)+")")}if($(".creno > a").html()){$(".creno > a").first().before("<a href='"+userurl+"' title='"+username+"' target='_blank'><img alt='"+username+"' src='"+userimage+"' /></a>")}else{$(".creno").append("<a href='"+userurl+"' title='"+username+"' target='_blank'><img alt='"+username+"' src='"+userimage+"' /></a>")}if($("#like"+id).hasClass("btnilike")){$("#like"+id).removeClass("btnilike").addClass("btndilike")}$("#like"+id).html('<a href="javascript:void(0);">喜欢'+msg.data.favs+"</a>");$(this).html('<a href="javascript:void(0);">喜欢'+msg.data.favs+"</a>")}}}}})}});$(".likeId a").click(function(){var obj=$(this);if(parseInt(obj.attr("dishid"))){var id=obj.attr("dishid");var params="&d_id="+id;$.ajax({type:"post",url:"/uajax/addDishFav",data:params,dataType:"json",success:function(msg){if(msg.data.flag=="NoLogin"){logindialog()}else{if(msg.data.flag=="slice"){showerrorinfo("提示",msg.data.favs)}else{if(msg.status=="OK"){obj.html(parseInt(msg.data.favs)+" 已喜欢");obj.removeClass("reczulikeed").addClass("reczulike");$(".opusic .imglikebtn[dishid="+id+"]").html("已喜欢");$(".opusic .imglikebtn[dishid="+id+"]").removeClass("btnsc").addClass("btnysc")}}}}})}});$(".imglikebtn").click(function(){var obj=$(this);if(parseInt(obj.attr("dishid"))&&obj.attr("class").indexOf("btnysc")<0){var id=obj.attr("dishid");var params="&d_id="+id;$.ajax({type:"post",url:"/uajax/addDishFav",data:params,dataType:"json",success:function(msg){if(msg.data.flag=="NoLogin"){logindialog()}else{if(msg.data.flag=="slice"){showerrorinfo("提示",msg.data.favs)}else{if(msg.status=="OK"){obj.html("已喜欢");obj.removeClass("btnsc").addClass("btnysc");$(".likeId a[dishid="+id+"]").html(parseInt(msg.data.favs)+" 已喜欢");$(".likeId a[dishid="+id+"]").removeClass("reczulikeed").addClass("reczulike")}}}}})}});$(".opusic").live({mouseover:function(){var dishid=$(this).attr("dishid");$(".opusic[dishid="+dishid+"]").children(".w28h21").addClass("opalpha9");$(".opusic .imglikebtn[dishid="+dishid+"]").show()},mouseout:function(){var dishid=$(this).attr("dishid");$(".opusic[dishid="+dishid+"]").children(".w28h21").removeClass("opalpha9");$(".opusic .imglikebtn[dishid="+dishid+"]").hide()}});$("#desc").keyup(function(){checkTextLength($(this))});$("#desc").mousedown(function(){checkTextLength($(this))});$("#desc").blur(function(){checkTextLength($(this))});$("#dish_sub").click(function(){var img=$("#img").val();if(!img){$(".zpwrong1").html("请上传作品图片");$(".zpwrong1").attr({"style":"visibility:block"});return false}var desc=$("#desc").val();if(desc.length>1000){$(".zpwrong2").html("心得描述过长啦，请惜墨如金~");$(".zpwrong2").attr({"style":"visibility:block"});return false}if($("#sinatoken").val()==1&&$("#bye").val()==0&&$("#sinasns").attr("checked")){}var sharetosns=$("#snsBtn").find("input[type=checkbox]:checked");var sharetosnsval="";if(sharetosns.size()>0){sharetosns.each(function(){sharetosnsval+="&sharetosns[]="+$(this).val()})}$("#dish_sub").html("提交中...");$("#dish_sub").attr("disabled","true");var method="createDish";var dishid=0;if($("#dish_id").val()>0){dishid=$("#dish_id").val();method="updateDish"}var cook_id=$("#cook_id").val();$.ajax({type:"post",url:"/uajax/"+method,data:"&img="+img+"&desc="+desc+"&cook="+cook_id+sharetosnsval+"&d_id="+dishid,dataType:"json",async:false,success:function(msg){if(msg.status=="OK"){window.location.href=msg.data.url}else{if(msg.data.tip!=""){$(".zpwrong1").html(msg.data.tip);$(".zpwrong1").attr({"style":"visibility:block;width:240px;"});$("#dish_sub").removeAttr("disabled");$("#dish_sub").html("发布");return false}}}})});$("#del_btn").click(function(){var d_id=$("#d_id").val();var c_id=$("#c_id").val();$.fn.confirm({msg:"确定删除这个作品？",callback:function(){$.ajax({type:"post",url:"/uajax/delDish",data:"&d_id="+d_id+"&c_id="+c_id,dataType:"json",async:false,success:function(msg){if(msg.data.flag=="OK"){window.location.reload()}else{if(msg.data.flag=="NoLogin"){logindialog()}else{if(msg.data.flag=="slice"){showerrorinfo("提示",msg.data.tip)}else{showerrorinfo("提示","删除失败！")}}}}})}})});$("#apan > span").live("click",function(){if($(this).attr("class")=="apre"||$(this).attr("class")=="anext"){var offset=$(this).attr("offset");var u_id=parseInt($("#u_id").val());var d_id=parseInt($("#d_id").val());if(u_id&&d_id){var params="offset="+offset+"&u_id="+u_id;$.ajax({type:"post",url:"/uajax/getDishUserAllList",data:params,dataType:"json",success:function(msg){if(msg.status=="OK"){var html="";var data=msg.data.list;for(var i in data){var onpic=data[i].dish_id==d_id?'class="onpic"':"";html+='<a href="'+data[i].dish_url+'"><img '+onpic+' alt="'+data[i].cook.name+'" src="'+data[i].image_url+'"></a>'}$("#rnext").attr("offset",msg.data.offset);$("#rprev").attr("offset",msg.data.prev);$("#rprev").removeClass("apre2").addClass("apre");$("#rnext").removeClass("anext2").addClass("anext");$("#rsta").html(msg.data.pagenow+"/"+msg.data.page);$("#dishrightlist").html(html);if(msg.data.pagenow==msg.data.page){$("#rnext").removeClass("anext").addClass("anext2")}if(msg.data.pagenow<=1){$("#rprev").removeClass("apre").addClass("apre2")}}}})}}});$("#imgUploadSucc").mouseover(function(){$("#imgUploadSucc .zpclose").show()});$("#imgUploadSucc").mouseout(function(){$("#imgUploadSucc .zpclose").hide()});$("#imgUploadSucc .zpclose").live("click",function(){$("#imgUploadSucc").hide();$("#imgUploadNow").show();$("#img").val("");$("#imgUploadNow div[specid=uploadspecid]").attr("id","uploadDishImage");$("#tipInfos").show();$(".iload").hide();editUploadImg($("#imgUploadNow div[specid=uploadspecid]"))});$("#uploadDishImage").live("click",function(){editUploadImg($(this))});$("input[name='sharetosns[]']").live("click",function(){if($(this).attr("checked")=="checked"){showThirdwithButton(this)}});if($("#uploadDishImage").length>0){$.ajax_upload("#uploadDishImage",{action:"/uajax/addDishImg",name:"uploadFile",data:{imgType:"coverImage"},dataType:"json",onSubmit:function(file,ext){$("#tipInfos").hide();$(".iload").show();ext=ext.toLowerCase();if(!(ext&&/^(jpg|png|jpeg|gif)$/i.test(ext))){$(".zpwrong1").html("对不起，上传作品失败。格式不对哦~");$(".zpwrong1").attr({"style":"visibility:block"});$("#tipInfos").show();$(".iload").hide();return false}},onComplete:function(file,msg){var msg=eval("("+msg+")");if(msg.code=="Success"){$(".zpwrong1").html("");$("#imgUploadNow").hide();$("#img").val(msg.upload);$("#imgUploadSucc img").attr("src",msg.imgUrl);$("#imgUploadSucc").show()}else{$(".zpwrong1").html("对不起，上传作品失败。请重试");$(".zpwrong1").attr({"style":"visibility:block"})}}})}});function editUploadImg(obj){var uploadDishImage=obj;$.ajax_upload(uploadDishImage,{action:"/uajax/addDishImg",name:"uploadFile",data:{imgType:"coverImage"},dataType:"json",onSubmit:function(file,ext){ext=ext.toLowerCase();if(!(ext&&/^(jpg|png|jpeg|gif)$/i.test(ext))){$(".zpwrong1").html("对不起，上传作品失败。格式不对哦~");$(".zpwrong1").attr({"style":"visibility:block"});return false}},onComplete:function(file,msg){var msg=eval("("+msg+")");$("#imgUploadSucc img").attr("src","");if(msg.code=="Success"){$(".zpwrong1").html("");$("#imgUploadNow").hide();$("#img").val(msg.upload);$("#imgUploadSucc img").attr("src",msg.imgUrl);$("#imgUploadSucc").show()}else{$(".zpwrong1").html("对不起，上传作品失败。请重试");$(".zpwrong1").attr({"style":"visibility:block"})}}})}function checkTextLength(A){var B=parseInt(A.val().length);$("#desc_tip").html(B);if(parseInt(B)>1000||parseInt(B)<=0){A.val(A.val().substr(0,1000));$(".zpwrong2").html("心得描述过长啦，请惜墨如金~");return false}else{A.val(A.val().substr(0,1000));$(".zpwrong2").html("")}};